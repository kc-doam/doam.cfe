// Таблица для хранения списка всех добавленных реквизитов, 
// аналог Свойства_ОписаниеДополнительныхРеквизитов в стандартной форме
&НаСервере
Процедура РасшДОАМ_СоздатьТаблицуОписанияРасширенныхРеквизитов(Реквизиты)
	
	ИмяОписания = "ТаблицаОписанияРасширенныхРеквизитов";
	
	Реквизиты.Добавить(Новый РеквизитФормы(
		ИмяОписания, Новый ОписаниеТипов("ТаблицаЗначений")));

	Реквизиты.Добавить(Новый РеквизитФормы(
		"Свойство", Новый ОписаниеТипов("ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения"),
			ИмяОписания));
			
	Реквизиты.Добавить(Новый РеквизитФормы(
		"Наименование", Новый ОписаниеТипов("Строка"), ИмяОписания));
	
	Реквизиты.Добавить(Новый РеквизитФормы(
		"ИмяПоля", Новый ОписаниеТипов("Строка"), ИмяОписания));
		
	Реквизиты.Добавить(Новый РеквизитФормы(
		"ТипЗначения", Новый ОписаниеТипов("ОписаниеТипов"), ИмяОписания));
			
	Реквизиты.Добавить(Новый РеквизитФормы(
		"ЗаполнятьОбязательно", Новый ОписаниеТипов("Булево"), ИмяОписания));
		
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииПоляРасширенногоРеквизита(Элемент)
	
	ПриИзмененииПоляРасширенногоРеквизитаНаСервере(Элемент.Имя);		
	
КонецПроцедуры

&НаСервере
Процедура ПриИзмененииПоляРасширенногоРеквизитаНаСервере(ИмяПоля)
	
	ЧистыйМассив = Новый Массив;
	
	МассивЗначений = ЭтаФорма[ИмяПоля].ВыгрузитьЗначения();
	Для Каждого текЗначение Из МассивЗначений Цикл		
		Если ЧистыйМассив.Найти(текЗначение) = Неопределено Тогда
			Если ЗначениеЗаполнено(текЗначение) Тогда
				ЧистыйМассив.Добавить(текЗначение);
			КонецЕсли;
		КонецЕсли;	
	КонецЦикла;
	
	ЭтаФорма[ИмяПоля].ЗагрузитьЗначения( ЧистыйМассив );
	
КонецПроцедуры

&НаСервере
Процедура РасшДОАМ_ПриСозданииНаСервереПеред(Отказ, СтандартнаяОбработка)
	
	//Есть = УправлениеДоступом.ЕстьПравоПоЗначениюДоступа("Редактирование", Объект.Ссылка, ПараметрыСеанса.ТекущийПользователь);
		
	ПодразделениеОтветственного = Объект.Ответственный.Подразделение;
	Пользователь = ПараметрыСеанса.ТекущийПользователь;
		
	Если НЕ Объект.Ссылка.Пустая() Тогда
		// //только если объект не новый
		
		//Если РольДоступна(Метаданные.Роли.ПолныеПрава) Тогда
			//Сообщить(Пользователь.Ссылка.Наименование + " имеет Полные Права!"); // Администратор
				
		Если Пользователь.Подразделение.Наименование = ""
			ИЛИ ПодразделениеОтветственного.Руководитель = Пользователь
			И ПроверкаПросмотраКонтрагентов
			ИЛИ Объект.Ответственный = Пользователь
			ИЛИ Объект.Ответственный = ЭтоДелегат И ПроверкаДелегата Тогда //// 2019-07-04
			
			//Сообщить(Пользователь.Ссылка.Наименование + " имеет Права доступа!"); // Пользователь
			
		Иначе			
			Если ПустаяСтрока(ПодразделениеОтветственного.Наименование) Тогда
		    	ПараметрСообщения = "Администратора системы";
			Иначе
				ПараметрСообщения = "Руководителя подразделения " + ПодразделениеОтветственного;
			КонецЕсли;
			
			Сообщить("Доступ к карточке контрагента «" + Объект.Наименование + "» возможен через " + ПараметрСообщения);
			Отказ = Истина;
			Возврат;
						
		КонецЕсли;
		// Перезаписывается только при "Записи" данных пользователя, но не при изменении Структуры предприятия
		//Сообщить(ПодразделениеОтветственного.Руководитель);
	КонецЕсли;
	
	// страница для расширенных реквизитов
	Страница 			= Элементы.Добавить("ГруппаРасширения", Тип("ГруппаФормы"), Элементы.Страницы);	
	Страница.Вид 		= ВидГруппыФормы.Страница;	
	Страница.Заголовок 	= "Расширенные реквизиты";
	
	Реквизиты 	= Новый Массив;
	
	РасшДОАМ_СоздатьТаблицуОписанияРасширенныхРеквизитов(Реквизиты);	
	
	// добавляются реквизиты формы	
	ТЗРеквизиты = ОбщийДОАМ.РасшДОАМ_ПолучитьРасширенныеРеквизиты();
	Для Каждого текРеквизит Из ТЗРеквизиты Цикл 
		ИмяПоля 	= текРеквизит.ИмяПоля; 		
		Реквизит 	= Новый РеквизитФормы(ИмяПоля, Новый ОписаниеТипов("СписокЗначений"),,текРеквизит.Наименование);	
		Реквизиты.Добавить(Реквизит);
	КонецЦикла;
	
	ЭтаФорма.ИзменитьРеквизиты(Реквизиты);
	
	ТЗРасширенныхРеквизитов = ЭтаФорма.ТаблицаОписанияРасширенныхРеквизитов;
	
	// создаются поля на форме
	Для Каждого текРеквизит Из ТЗРеквизиты Цикл
		                      
		ИмяПоля 			= текРеквизит.ИмяПоля;
		СвойствоРеквизит 	= текРеквизит.Свойство;
		ТипЗначения			= текРеквизит.ТипЗначения;
	    ЗаголовокРеквизита	= текРеквизит.Наименование;
		
		ЭтаФорма[ИмяПоля].ТипЗначения  	= ТипЗначения; // Новый ОписаниеТипов("СправочникСсылка.ЗначенияСвойствОбъектовИерархия"); или 	Новый ОписаниеТипов("СправочникСсылка.ЗначенияСвойствОбъектов");
		НовыйЭлемент 							= Элементы.Вставить(ИмяПоля, Тип("ПолеФормы"), Страница);
		НовыйЭлемент.Вид						= ВидПоляФормы.ПолеВвода;
		НовыйЭлемент.ПутьКДанным				= ИмяПоля;
		НовыйЭлемент.Заголовок					= ЗаголовокРеквизита;
		НовыйЭлемент.АвтоОтметкаНезаполненного  = текРеквизит.ЗаполнятьОбязательно;
		НовыйЭлемент.УстановитьДействие("ПриИзменении", "ПриИзмененииПоляРасширенногоРеквизита");
		
		// установить параметры выбора, чтобы при выборе в списке отображался только нужный тип данных
		ПараметрСвойство						= Новый ПараметрВыбора("Отбор.Владелец", СвойствоРеквизит);
		МассивПараметров						= Новый Массив();
		МассивПараметров.Добавить(ПараметрСвойство);
		ФиксМассПараметров						= Новый ФиксированныйМассив(МассивПараметров);
		НовыйЭлемент.ПараметрыВыбора			= ФиксМассПараметров; 
	
		// загрузка значений в реквизиты формы из регистра
		ТЗ = Объект.РасширенныеРеквизиты.Выгрузить(Новый Структура("Свойство", СвойствоРеквизит), "Значение");
		МассивЗначений = ТЗ.ВыгрузитьКолонку("Значение"); 
		ЭтаФорма[ИмяПоля].ЗагрузитьЗначения( МассивЗначений );
		
		НоваяСтрока = ТЗРасширенныхРеквизитов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, текРеквизит);
		
	КонецЦикла;
		
КонецПроцедуры

&НаСервере
Процедура РасшДОАМ_ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	// требуется сохранить все значения расширенных реквизитов	
	ТЗРасширенныхРеквизитов = ЭтаФорма.ТаблицаОписанияРасширенныхРеквизитов;
	Объект.РасширенныеРеквизиты.Очистить();
	ТЗ = Объект.РасширенныеРеквизиты.Выгрузить().СкопироватьКолонки();
	Для Каждого текРеквизит Из ТЗРасширенныхРеквизитов Цикл
		
		ИмяПоля 			= текРеквизит.ИмяПоля;
		СвойствоРеквизит 	= текРеквизит.Свойство;
		
		МассивЗначений 		= ЭтаФорма[ИмяПоля].ВыгрузитьЗначения();
		Для Каждого текЗначение Из МассивЗначений Цикл
		    НоваяСтрока = ТЗ.Добавить();
			НоваяСтрока.Свойство = СвойствоРеквизит;
			НоваяСтрока.Значение = текЗначение;
		КонецЦикла;
	
	КонецЦикла;
	ТекущийОбъект.РасширенныеРеквизиты.Загрузить(ТЗ);
	
КонецПроцедуры


&НаСервере
// проверяется заполненность обязательных полей расширенных реквизитов 
// (для обычных доп реквизитов это уже реализовано в стандартном модуле)
Процедура РасшДОАМ_ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	ТЗРасширенные = ЭтаФорма.ТаблицаОписанияРасширенныхРеквизитов;
	Для Каждого текРеквизит Из ТЗРасширенные Цикл 		

		Если Элементы[текРеквизит.ИмяПоля].ОтметкаНезаполненного Тогда
	    	Сообщить("Поле: """ + текРеквизит.Наименование + """ не заполнено");
			Отказ = Истина;
		КонецЕсли;
	
	КонецЦикла;
					
КонецПроцедуры
